name: Terraform Apply from Approved Plan

on:
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

env:
  TF_WORKING_DIR: .
  TF_PLAN_FILE: tfplan

jobs:
  apply:
    name: Terraform apply (after merged PR)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      actions: read
      id-token: write

    steps:
      - name: Find latest successful plan run for this PR
        id: find-run
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prHeadSha = context.payload.pull_request.head.sha;
            core.info(`=== DEBUG: Looking for plan run for PR #${prNumber} ===`);
            core.info(`PR Head SHA: ${prHeadSha}`);

            // Locate the workflow by name
            const workflowName = 'Terraform PR Plan';
            core.info(`Searching for workflow: "${workflowName}"`);
            
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            // Debug: Log all available workflows
            core.info(`=== Available workflows (${workflows.workflows.length} total) ===`);
            workflows.workflows.forEach((w, index) => {
              core.info(`${index + 1}. ID: ${w.id}, Name: "${w.name}", Path: ${w.path}, State: ${w.state}`);
            });

            const workflow = workflows.workflows.find(w => w.name === workflowName);
            if (!workflow) {
              const availableNames = workflows.workflows.map(w => `"${w.name}"`).join(', ');
              core.setFailed(`Workflow '${workflowName}' not found. Available workflows: ${availableNames}`);
              return;
            }

            core.info(`=== Found target workflow ===`);
            core.info(`Workflow ID: ${workflow.id}, Name: "${workflow.name}", State: ${workflow.state}`);

            // Find workflow runs by matching head SHA (more reliable than PR association)
            core.info(`=== Fetching workflow runs ===`);
            const runsResp = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow.id,
              head_sha: prHeadSha,
              per_page: 50,
            });

            const runs = runsResp.data.workflow_runs || [];
            core.info(`Found ${runs.length} workflow runs for head SHA: ${prHeadSha}`);

            // Debug: Log all workflow runs with details
            core.info(`=== Workflow runs for this PR's head SHA ===`);
            runs.forEach((r, index) => {
              const prs = r.pull_requests ? r.pull_requests.map(pr => `#${pr.number}`).join(',') : 'none';
              core.info(`${index + 1}. Run ID: ${r.id}, Status: ${r.status}, Conclusion: ${r.conclusion}, PRs: ${prs}, Head SHA: ${r.head_sha}, Created: ${r.created_at}`);
            });

            // Find successful runs
            const successfulRuns = runs.filter(r => r.conclusion === 'success');
            core.info(`=== Successful runs (${successfulRuns.length} found) ===`);
            successfulRuns.forEach((r, index) => {
              core.info(`${index + 1}. Run ID: ${r.id}, Created: ${r.created_at}`);
            });

            // Get the most recent successful run
            const run = successfulRuns.length > 0 ? successfulRuns[0] : null;

            if (!run) {
              core.setFailed(`No successful plan run found for PR #${prNumber} with head SHA ${prHeadSha}. Checked ${runs.length} total runs, ${successfulRuns.length} successful.`);
              return;
            }

            core.info(`=== SUCCESS: Using plan from workflow run ===`);
            core.info(`Run ID: ${run.id}, Created: ${run.created_at}, Head SHA: ${run.head_sha}`);
            core.setOutput('plan_run_id', String(run.id));

      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Debug artifact download info
        run: |
          echo "=== Artifact Download Debug Info ==="
          echo "Artifact name: tfplan-pr-${{ github.event.pull_request.number }}"
          echo "Download path: ${{ env.TF_WORKING_DIR }}"
          echo "Source run ID: ${{ steps.find-run.outputs.plan_run_id }}"
          echo "PR number: ${{ github.event.pull_request.number }}"

      - name: List available artifacts from the plan run
        uses: actions/github-script@v7
        with:
          script: |
            const runId = ${{ steps.find-run.outputs.plan_run_id }};
            core.info(`=== Listing artifacts from workflow run ${runId} ===`);
            
            try {
              const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId,
              });

              core.info(`Found ${artifacts.artifacts.length} artifacts in run ${runId}:`);
              artifacts.artifacts.forEach((artifact, index) => {
                core.info(`${index + 1}. Name: "${artifact.name}", Size: ${artifact.size_in_bytes} bytes, Created: ${artifact.created_at}, Expired: ${artifact.expired}`);
              });

              if (artifacts.artifacts.length === 0) {
                core.warning(`No artifacts found in run ${runId}. The plan workflow may have failed to upload the artifact.`);
              }
            } catch (error) {
              core.error(`Failed to list artifacts: ${error.message}`);
            }

      - name: Find and download the correct artifact
        id: find-and-download-artifact
        uses: actions/github-script@v7
        with:
          script: |
            const runId = ${{ steps.find-run.outputs.plan_run_id }};
            const prNumber = ${{ github.event.pull_request.number }};
            const expectedArtifactName = `tfplan-pr-${prNumber}`;
            
            core.info(`=== Attempting to find and download artifact ===`);
            core.info(`Expected artifact name: ${expectedArtifactName}`);
            
            // Get all artifacts from the run
            const { data: artifacts } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId,
            });

            // Try to find the exact artifact name first
            let artifact = artifacts.artifacts.find(a => a.name === expectedArtifactName);
            
            if (!artifact) {
              // If exact name not found, try to find any artifact that looks like a terraform plan
              const planArtifacts = artifacts.artifacts.filter(a => 
                a.name.includes('tfplan') || 
                a.name.includes('terraform') || 
                a.name.includes('plan')
              );
              
              core.info(`Exact artifact name not found. Found ${planArtifacts.length} plan-related artifacts:`);
              planArtifacts.forEach(a => core.info(`- ${a.name}`));
              
              if (planArtifacts.length === 1) {
                artifact = planArtifacts[0];
                core.info(`Using single plan artifact: ${artifact.name}`);
              } else if (planArtifacts.length > 1) {
                // Try to find one that matches our PR number
                artifact = planArtifacts.find(a => a.name.includes(prNumber.toString()));
                if (artifact) {
                  core.info(`Using artifact matching PR number: ${artifact.name}`);
                } else {
                  artifact = planArtifacts[0]; // Use the first one as fallback
                  core.info(`Using first plan artifact as fallback: ${artifact.name}`);
                }
              }
            }

            if (!artifact) {
              core.setFailed(`No terraform plan artifact found in workflow run ${runId}`);
              return;
            }

            core.info(`Selected artifact: ${artifact.name} (${artifact.size_in_bytes} bytes)`);
            core.setOutput('artifact_name', artifact.name);
            core.setOutput('artifact_id', artifact.id);

      - name: Download the selected artifact
        uses: actions/download-artifact@v6
        with:
          artifact-id: ${{ steps.find-and-download-artifact.outputs.artifact_id }}
          path: ${{ env.TF_WORKING_DIR }}
          run-id: ${{ steps.find-run.outputs.plan_run_id }}

      - name: Verify downloaded plan file
        run: |
          echo "=== Verifying Plan File ==="
          echo "Working directory contents:"
          ls -la ${{ env.TF_WORKING_DIR }}
          echo "Looking for plan file: ${{ env.TF_PLAN_FILE }}"
          if [ -f "${{ env.TF_WORKING_DIR }}/${{ env.TF_PLAN_FILE }}" ]; then
            echo "✅ Plan file found!"
            file "${{ env.TF_WORKING_DIR }}/${{ env.TF_PLAN_FILE }}"
          else
            echo "❌ Plan file NOT found!"
            exit 1
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.7

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Debug terraform apply command
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          echo "=== Terraform Apply Debug ==="
          echo "Working directory: $(pwd)"
          echo "Plan file: ${{ env.TF_PLAN_FILE }}"
          echo "Command to execute: terraform apply -auto-approve ${{ env.TF_PLAN_FILE }}"
          echo "Terraform version:"
          terraform version

      - name: Terraform apply saved plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve ${{ env.TF_PLAN_FILE }}