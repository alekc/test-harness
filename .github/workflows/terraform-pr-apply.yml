name: Terraform Apply from Approved Plan

on:
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

env:
  TF_WORKING_DIR: .
  TF_PLAN_FILE: tfplan

jobs:
  apply:
    name: Terraform apply (after merged PR)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      actions: read
      id-token: write

    steps:
      - name: Find latest successful plan run for this PR
        id: find-run
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;

            // Locate the workflow by name
            const workflowName = 'Terraform PR Plan';
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const workflow = workflows.workflows.find(w => w.name === workflowName);
            if (!workflow) {
              core.setFailed(`Workflow '${workflowName}' not found.`);
              return;
            }

            // Find the most recent successful run of that workflow that belongs to this PR
            const runsResp = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflow.id,
              per_page: 50,
            });

            const runs = runsResp.data.workflow_runs || [];

            const run = runs.find(r =>
              r.conclusion === 'success' &&
              Array.isArray(r.pull_requests) &&
              r.pull_requests.some(pr => pr.number === prNumber)
            );

            if (!run) {
              core.setFailed(`No successful plan run found for PR #${prNumber}.`);
              return;
            }

            core.info(`Using plan from workflow_run id=${run.id} for PR #${prNumber}.`);
            core.setOutput('plan_run_id', String(run.id));

      - name: Checkout merged commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      - name: Download approved plan artifact from plan run
        uses: actions/download-artifact@v4
        with:
          name: tfplan-pr-${{ github.event.pull_request.number }}
          path: ${{ env.TF_WORKING_DIR }}
          run-id: ${{ steps.find-run.outputs.plan_run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.7

      - name: Terraform init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform apply saved plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve ${{ env.TF_PLAN_FILE }}